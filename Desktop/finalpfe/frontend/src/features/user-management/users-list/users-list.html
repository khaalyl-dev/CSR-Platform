<!--
  Users list page: header, create form (collapsible), users table, password modal.
  Table: user name (link to detail), email, role badge, status, actions (activate, generate pwd, manage).
-->
<div class="p-6 lg:p-8 max-w-7xl mx-auto space-y-6">
  <!-- Header -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <div>
      <h1 class="text-2xl font-bold text-gray-900">Gestion des utilisateurs</h1>
      <p class="mt-1 text-sm text-gray-500">Créez et gérez les comptes utilisateurs et leurs accès aux sites</p>
    </div>
    <button
      type="button"
      (click)="toggleCreateForm()"
      class="inline-flex items-center gap-2 px-4 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium shadow-sm transition-colors"
    >
      <fa-icon [icon]="faUserPlus"></fa-icon>
      {{ showCreateForm() ? 'Annuler' : 'Nouvel utilisateur' }}
    </button>
  </div>

  @if (successMessage(); as msg) {
    <div class="p-4 bg-emerald-50 border border-emerald-200 rounded-lg text-emerald-800 text-sm flex items-center gap-2">
      <fa-icon [icon]="faCheck" class="text-emerald-600"></fa-icon>
      {{ msg }}
    </div>
  }

  @if (errorMessage(); as msg) {
    <div class="p-4 bg-red-50 border border-red-200 rounded-lg text-red-700 text-sm">{{ msg }}</div>
  }

  <!-- Create form -->
  @if (showCreateForm()) {
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
      <div class="px-6 py-4 border-b border-gray-100 bg-gray-50">
        <h2 class="text-lg font-semibold text-gray-900">Créer un utilisateur</h2>
        <p class="text-sm text-gray-500 mt-0.5">Renseignez les informations du compte</p>
      </div>
      <form [formGroup]="createForm" (ngSubmit)="onSubmitCreate()" class="p-6 space-y-5">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1.5">Prénom</label>
            <input formControlName="first_name" type="text" placeholder="Jean"
              class="w-full px-3.5 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1.5">Nom</label>
            <input formControlName="last_name" type="text" placeholder="Dupont"
              class="w-full px-3.5 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" />
          </div>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-5">
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1.5">Email</label>
            <input formControlName="email" type="email" placeholder="jean.dupont&#64;exemple.com"
              class="w-full px-3.5 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1.5">Mot de passe initial</label>
            <input formControlName="password" type="password" placeholder="••••••••" minlength="6"
              class="w-full px-3.5 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" />
          </div>
        </div>
        <div class="pt-4 border-t border-gray-100">
            <label class="flex items-center gap-2 text-sm font-medium text-gray-700 mb-2">
              <fa-icon [icon]="faBuilding" class="text-gray-400"></fa-icon>
              Accès aux sites
            </label>
            <div class="flex flex-wrap gap-2">
              @for (site of sites(); track site.id) {
                <label
                  class="inline-flex items-center gap-2 px-3 py-2 border rounded-lg cursor-pointer transition"
                  [class.border-indigo-500]="isSiteSelected(site.id)"
                  [class.bg-indigo-50]="isSiteSelected(site.id)"
                  [class.border-gray-200]="!isSiteSelected(site.id)"
                  [class.hover:bg-gray-50]="!isSiteSelected(site.id)">
                  <input type="checkbox" [checked]="isSiteSelected(site.id)"
                    (change)="toggleSiteSelection(site.id)" class="rounded border-gray-300 text-indigo-600" />
                  <span class="text-sm">{{ site.name }} ({{ site.code }})</span>
                </label>
              }
            </div>
            @if (sites().length === 0) {
              <p class="text-sm text-amber-600 mt-1">Aucun site actif. Exécutez init_db.py pour ajouter des sites.</p>
            }
          </div>

        <div class="flex gap-3 pt-2">
          <button type="submit"
            class="inline-flex items-center gap-2 px-4 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium disabled:opacity-50 disabled:cursor-not-allowed transition"
            [disabled]="createForm.invalid">
            <fa-icon [icon]="faUserPlus"></fa-icon>
            Créer l'utilisateur
          </button>
          <button type="button" (click)="toggleCreateForm()"
            class="px-4 py-2.5 border border-gray-300 rounded-lg hover:bg-gray-50 font-medium transition">
            Annuler
          </button>
        </div>
      </form>
    </div>
  }

  <!-- Users table -->
  <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
    @if (loading()) {
      <div class="p-12 text-center">
        <div class="inline-block h-8 w-8 animate-spin rounded-full border-2 border-indigo-600 border-t-transparent"></div>
        <p class="mt-3 text-gray-500">Chargement des utilisateurs...</p>
      </div>
    } @else {
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3.5 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Utilisateur</th>
              <th class="px-6 py-3.5 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Email</th>
              <th class="px-6 py-3.5 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Rôle</th>
              <th class="px-6 py-3.5 text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Statut</th>
              <th class="px-6 py-3.5 text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Actions</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            @for (user of users(); track user.id) {
              <tr class="hover:bg-gray-50/50 transition" [class.opacity-60]="!user.is_active">
                <td class="px-6 py-4">
                  <a [routerLink]="['/admin/users', user.id]"
                    class="font-medium text-indigo-600 hover:text-indigo-800 hover:underline">
                    {{ user.first_name }} {{ user.last_name }}
                  </a>
                </td>
                <td class="px-6 py-4 text-sm text-gray-700">{{ user.email }}</td>
                <td class="px-6 py-4">
                  <span class="inline-flex px-2.5 py-1 text-xs font-medium rounded-md"
                    [class.bg-indigo-100]="user.role === 'CORPORATE_USER'"
                    [class.text-indigo-800]="user.role === 'CORPORATE_USER'"
                    [class.bg-gray-100]="user.role === 'SITE_USER'"
                    [class.text-gray-800]="user.role === 'SITE_USER'">
                    {{ roleLabel(user.role) }}
                  </span>
                </td>
                <td class="px-6 py-4">
                  <span class="inline-flex px-2.5 py-1 text-xs font-medium rounded-full"
                    [class.bg-emerald-100]="user.is_active"
                    [class.text-emerald-800]="user.is_active"
                    [class.bg-red-100]="!user.is_active"
                    [class.text-red-800]="!user.is_active">
                    {{ user.is_active ? 'Actif' : 'Désactivé' }}
                  </span>
                </td>
                <td class="px-6 py-4 text-right">
                  <div class="flex items-center justify-end gap-2">
                    <button
                      (click)="toggleActive(user)"
                      [disabled]="actionLoading() === user.id"
                      [title]="user.is_active ? 'Désactiver' : 'Activer'"
                      class="p-2 rounded-lg transition"
                      [class.text-amber-600]="user.is_active"
                      [class.hover:bg-amber-50]="user.is_active"
                      [class.text-emerald-600]="!user.is_active"
                      [class.hover:bg-emerald-50]="!user.is_active">
                      @if (user.is_active) {
                        <fa-icon [icon]="faBan"></fa-icon>
                      } @else {
                        <fa-icon [icon]="faCheck"></fa-icon>
                      }
                    </button>
                    <button
                      (click)="generatePassword(user)"
                      [disabled]="actionLoading() === user.id"
                      title="Générer un nouveau mot de passe"
                      class="p-2 rounded-lg text-gray-500 hover:bg-gray-100 hover:text-indigo-600 transition">
                      <fa-icon [icon]="faKey"></fa-icon>
                    </button>
                    <a [routerLink]="['/admin/users', user.id]"
                      class="px-3 py-1.5 text-sm font-medium text-indigo-600 hover:bg-indigo-50 rounded-lg transition">
                      Gérer
                    </a>
                  </div>
                </td>
              </tr>
            }
          </tbody>
        </table>
      </div>
      @if (users().length === 0) {
        <div class="p-12 text-center text-gray-500">
          <p class="font-medium">Aucun utilisateur</p>
          <p class="text-sm mt-1">Créez un premier utilisateur pour commencer</p>
        </div>
      }
    }
  </div>
</div>

<!-- Password modal -->
@if (showPasswordModal()) {
  <div class="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50" (click)="closePasswordModal()">
    <div class="bg-white rounded-xl shadow-xl max-w-md w-full p-6" (click)="$event.stopPropagation()">
      <div class="flex items-center gap-3 mb-4">
        <div class="p-2 bg-amber-100 rounded-lg">
          <fa-icon [icon]="faKey" class="text-amber-600"></fa-icon>
        </div>
        <div>
          <h3 class="font-semibold text-gray-900">Nouveau mot de passe</h3>
          <p class="text-sm text-gray-500">{{ userForPassword() }}</p>
        </div>
      </div>
      <div class="p-4 bg-gray-50 rounded-lg font-mono text-sm break-all mb-4">
        {{ generatedPassword() }}
      </div>
      <p class="text-xs text-amber-600 mb-4">
        Transmettez ce mot de passe de manière sécurisée. Il ne sera plus affiché.
      </p>
      <div class="flex gap-3">
        <button (click)="copyPassword()"
          class="flex-1 px-4 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium transition">
          Copier
        </button>
        <button (click)="closePasswordModal()"
          class="px-4 py-2.5 border border-gray-300 rounded-lg hover:bg-gray-50 font-medium transition">
          Fermer
        </button>
      </div>
    </div>
  </div>
}
